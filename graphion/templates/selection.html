<!--
Author(s): Tom Udding
Created: 2019-04-29
Edited: 2019-06-20
-->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>graphion - file selection</title>
		<link rel="stylesheet" type="text/css" href="/static/css/grid.css">
		<link rel="stylesheet" type="text/css" href="/static/css/grid_style.css">
	    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:100,400,700">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.css" integrity="sha256-e47xOkXs1JXFbjjpoRr1/LhVcqSzRmGmPqsrUQeVs+g=" crossorigin="anonymous">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.js" integrity="sha256-cs4thShDfjkqFGk5s2Lxj35sgSRr4MRcyccmi0WKqCM=" crossorigin="anonymous"></script>
		<style>body { background: url("/static/images/first.png") no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover; }</style>
		<style>.file-selection-container ul { list-style: none; } .file-selection-container ul li::before { content: "\2014"; color: rgb(49, 137, 255); font-weight: bold; display: inline-block; width: 1rem; }</style>
		<style>
			.dropzone {
				border: 2px dashed rgb(49, 137, 255);
				min-height: 0;
			}

			.dropzone .dz-preview {
				width: calc(100% - 2.5rem);
				min-height: 0;
			}

			.dropzone .dz-preview .dz-progress {
				opacity: 1;
				z-index: 1000;
				pointer-events: none;
				position: relative;
				height: 0.25rem;
				left: 0;
				top: 0;
				margin: 0;
				background: rgb(209, 209, 209);
				border-radius: 8px;
				overflow: hidden;
				width: 100%;
				animation: none !important;
			}

			.dropzone .dz-preview .dz-progress .dz-upload {
				background: rgb(49, 137, 255);
				background: -moz-linear-gradient(left, rgb(49, 137, 255) 0%, rgb(0, 97, 228) 100%);
				background: -webkit-linear-gradient(left, rgb(49, 137, 255) 0%, rgb(0, 97, 228) 100%);
				background: -o-linear-gradient(left, rgb(49, 137, 255) 0%, rgb(0, 97, 228) 100%);
				background: -ms-linear-gradient(left, rgb(49, 137, 255) 0%, rgb(0, 97, 228) 100%);
				background: linear-gradient(to right, rgb(49, 137, 255) 0%, rgb(0, 97, 228) 100%);
			}

			.preview-container #previews-matrix .graphion-matrix-dropzone-info,
			.preview-container #previews-edgelist .graphion-edgelist-dropzone-info {
			    display: flex;
			    flex-wrap: nowrap;
				width: calc(100% - 1.25rem);
				height: 3rem;
			}

			.preview-container #previews-matrix .graphion-matrix-dropzone-info > .thumb-container,
			.preview-container #previews-edgelist .graphion-edgelist-dropzone-info > .thumb-container {
			    flex: 0 0 3.125rem;
			    max-width: 3.125rem;
			    border-radius: 10px;
			    overflow: hidden;
			}

			.preview-container #previews-matrix .graphion-matrix-dropzone-info img,
			.preview-container #previews-edgelist .graphion-edgelist-dropzone-info img {
			    max-width: 100%;
			    height: auto;
			}

			.preview-container #previews-matrix .graphion-matrix-dropzone-info > .details,
			.preview-container #previews-edgelist .graphion-edgelist-dropzone-info > .details {
			    position: relative;
			    flex: 0 0 calc(100% - 3.125rem);
			    max-width: calc(100% - 3.125rem);
			}

			#previews-matrix > div,
			#previews-edgelist > div {
			    display: -webkit-flex;
			    display: -ms-flexbox;
			    display: flex;
			    -webkit-align-items: flex-start;
			    -ms-flex-align: flex-start;
			    align-items: flex-start;
			}

			.thumb-container {
			    position: relative;
			}

			.type-csv .thumb-container::after,
			.type-edges .thumb-container::after {
				content: '';
			    position: absolute;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    left: 0;
			    background-size: cover;
			    background-size: 100% 100%;
			    background-position: left center;
			    background-repeat: no-repeat;
			}

			.type-csv .thumb-container::after {
    			background-image: url("/static/images/icons/icon-file-csv.svg");
			}

			.type-edges .thumb-container::after {
    			background-image: url("/static/images/icons/icon-file-edges.svg");
			}
		</style>
	</head>
	<body>
		{% include "header.html" %}
		<section class="body-wrapper valign-wrapper">
			<div class="container">
				<div class="row">
					<div class="col-s-8 col-offset-2 valign">
						<div class="card-container">
							<div class="card-contents">
								<h2 class="card-title text-center">Select or upload a file</h2>
								<div class="card-body">
									<p class="card-subtitle text-center">Please select a previously uploaded data set from the list or upload a new data set.</p>
									<hr>
									{% include "flash.html" %}
									<div class="row file-selection-container" style="display: none">
										<div class="col-s-12">
											{% if filesList is defined and filesList|length >= 0 %}
												<ul>
													{% if filesList|length <= 0 %}
														<li>No files have been uploaded</li>
													{% else %}
														{% for key, value in filesList.items() %}
															<li><a href="filter/{{ key|e }}">{{ value|e }}</a></li>
														{% endfor %}
													{% endif %}
												</ul>
											{% else %}
												<p>An unknown error has occurred while trying to retrieve previously uploaded data sets. Try again later.</p>
											{% endif %}
										</div>
									</div>
									<div class="row file-upload-container" style="display: none;">
										<div class="col-s-12 col-0-margin">
											<div class="row">
												<div class="col-s-4 col-offset-2">
													<button class="button button-primary" id="file-selection-upload-edgelist">Upload Edge List</button>
												</div>
												<div class="col-s-4">
													<button class="button button-primary" id="file-selection-upload-matrix">Upload Matrix</button>
												</div>
											</div>
										</div>
									</div>
									<div class="row file-upload-matrix-container" style="display: none;">
										<div class="col-s-12">
											<form action="/upload_matrix" method="post" class="dropzone" id="graphion-matrix-dropzone" enctype="multipart/form-data">
												<div class="fallback">
													<input type="file" name="file" accept=".csv, text/csv">
													<input type="submit" class="button button-primary" value="Submit" name="submit">
												</div>
												<div class="preview-container dz-preview uploaded-files preview-matrix-container">
													<div id="previews-matrix">
														<div id="graphion-matrix-dropzone-template">
															<div class="graphion-matrix-dropzone-info">
																<div class="thumb-container">
																	<img data-dz-thumbnail />
																</div>
																<div class="details">
																	<div>
																		<span data-dz-name></span> <span data-dz-size></span>
																	</div>
																	<div class="dz-progress matrix"><span class="dz-upload" data-dz-uploadprogress-matrix></span></div>
																	<div class="loader bar" style="display: none"><div class="intermediate"></div></div>
																	<div class="dz-error-message"><span data-dz-errormessage></span></div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</form>
										</div>
									</div>
									<div class="row file-upload-edgelist-container" style="display: none">
										<div class="col-s-12">
											<form action="/upload_edgelist" method="post" class="dropzone" id="graphion-edgelist-dropzone" enctype="multipart/form-data">
												<div class="fallback">
													<input type="file" name="file" accept=".txt,.edges,.edgelist">
													<input type="submit" class="button button-primary" value="Submit" name="submit">
												</div>
												<div class="preview-container dz-preview uploaded-files preview-edgelist-container">
													<div id="previews-edgelist">
														<div id="graphion-edgelist-dropzone-template">
															<div class="graphion-edgelist-dropzone-info">
																<div class="thumb-container">
																	<img data-dz-thumbnail />
																</div>
																<div class="details">
																	<div>
																		<span data-dz-name></span> <span data-dz-size></span>
																	</div>
																	<div class="dz-progress edgelist"><span class="dz-upload" data-dz-uploadprogress-edgelist></span></div>
																	<div class="loader bar" style="display: none"><div class="intermediate"></div></div>
																	<div class="dz-error-message"><span data-dz-errormessage></span></div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</form>
										</div>
									</div>
									<div class="row">
										<div class="col-s-12 col-0-margin">
											<div class="row" id="file-selection-buttons">
												<div class="col-s-4 col-offset-2">
													<button class="button button-primary" id="file-selection-list">Previously Uploaded</button>
												</div>
												<div class="col-s-4">
													<button class="button button-primary" id="file-selection-upload">Upload New File</button>
												</div>
											</div>
											<div class="row">
												<div class="col-s-2" style="margin: 0 auto;">
													<button class="button button-primary" id="file-selection-back" style="display: none;">Back</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</body>
	<script>
		var selectionState = "start";

		document.getElementById("file-selection-list").addEventListener('click', function() {
			selectionState = "list-choose";
			toggleButtons();
			removeAlerts();
			document.querySelector(".card-title").textContent = "Select a file";
			document.querySelector(".card-subtitle").textContent = "Select a file.";
			document.querySelector(".file-upload-matrix-container").style.display = "none";
			document.querySelector(".file-selection-container").style.display = "flex";
		}, false);

		document.getElementById("file-selection-upload").addEventListener('click', function() {
			selectionState = "upload-choose";
			toggleButtons();
			removeAlerts();
			document.querySelector(".card-title").textContent = "Upload a file";
			document.querySelector(".card-subtitle").textContent = "Upload an edge list or adjacency matrix.";
			document.querySelector(".file-selection-container").style.display = "none";
			document.querySelector(".file-upload-container").style.display = "flex";
		}, false);

		document.getElementById("file-selection-upload-edgelist").addEventListener('click', function() {
			selectionState = "upload-edgelist";
			toggleButtons();
			removeAlerts();
			document.querySelector(".card-title").textContent="Upload a file";
			document.querySelector(".card-subtitle").textContent = "Upload an edge list.";
			document.querySelector(".file-upload-container").style.display = "none";
			document.querySelector(".file-upload-edgelist-container").style.display = "flex";
		}, false);

		document.getElementById("file-selection-upload-matrix").addEventListener('click', function() {
			selectionState = "upload-matrix";
			toggleButtons();
			removeAlerts();
			document.querySelector(".card-title").textContent="Upload a file";
			document.querySelector(".card-subtitle").textContent = "Upload an adjacency matrix.";
			document.querySelector(".file-upload-container").style.display = "none";
			document.querySelector(".file-upload-matrix-container").style.display = "flex";
		}, false);

		document.getElementById("file-selection-back").addEventListener('click', function() {
			removeAlerts();
			if (selectionState == "list-choose" || selectionState == "upload-choose") {
				selectionState = "start";
				toggleButtons();
				document.querySelector(".card-title").textContent="Select or upload a file";
				document.querySelector(".card-subtitle").textContent = "Please select a previously uploaded data set from the list or upload a new data set.";
				document.querySelector(".file-selection-container").style.display = "none";
				document.querySelector(".file-upload-container").style.display = "none";
			} else if (selectionState == "upload-edgelist" || selectionState == "upload-matrix") {
				document.getElementById("file-selection-upload-edgelist").style.display = "none";
				document.getElementById("file-selection-upload-matrix").style.display = "none";
				if (selectionState == "upload-edgelist") {
					document.querySelector(".file-upload-edgelist-container").style.display = "none";
				} else if (selectionState == "upload-matrix") {
					document.querySelector(".file-upload-matrix-container").style.display = "none";
				}
				selectionState = "upload-choose";
				toggleButtons();
				document.querySelector(".card-title").textContent="Upload a file";
				document.querySelector(".card-subtitle").textContent = "Upload an edge list or adjacency matrix.";
				document.querySelector(".file-upload-container").style.display = "flex";
			}
		}, false);

		function removeAlerts() {
			var alertContainers = document.querySelectorAll("[class*='alert-']");
			alertContainers.forEach(function(container) {
				container.style.display = "none";
			});
		}

		function toggleButtons() {
			if (selectionState == "start") {
				if (window.getComputedStyle(document.getElementById("file-selection-back")).getPropertyValue("display") == "none") {
					document.getElementById("file-selection-back").style.display = "inline-block";
					document.getElementById("file-selection-buttons").style.display = "none";
					document.getElementById("file-selection-list").style.display = "none";
					document.getElementById("file-selection-upload").style.display = "none";
				} else {
					document.getElementById("file-selection-back").style.display = "none";
					document.getElementById("file-selection-buttons").style.display = "flex";
					document.getElementById("file-selection-list").style.display = "inline-block";
					document.getElementById("file-selection-upload").style.display = "inline-block";
				}
			} else if (selectionState == "list-choose" || selectionState == "upload-choose") {
				if (window.getComputedStyle(document.getElementById("file-selection-back")).getPropertyValue("display") == "none") {
					document.getElementById("file-selection-back").style.display = "inline-block";
					document.getElementById("file-selection-buttons").style.display = "none";
					document.getElementById("file-selection-list").style.display = "none";
					document.getElementById("file-selection-upload").style.display = "none";
				} else {
					document.getElementById("file-selection-list").style.display = "inline-block";
					document.getElementById("file-selection-upload").style.display = "inline-block";
					document.getElementById("file-selection-upload-edgelist").style.display = "inline-block";
					document.getElementById("file-selection-upload-matrix").style.display = "inline-block";
				}
			} else if (selectionState == "upload-edgelist" || selectionState == "upload-matrix") {
				if (window.getComputedStyle(document.getElementById("file-selection-back")).getPropertyValue("display") == "none") {
					document.getElementById("file-selection-back").style.display = "inline-block";
					document.getElementById("file-selection-buttons").style.display = "none";
					document.getElementById("file-selection-upload-edgelist").style.display = "none";
					document.getElementById("file-selection-upload-matrix").style.display = "none";
				} else {
					document.getElementById("file-selection-buttons").style.display = "none";
					document.getElementById("file-selection-upload-edgelist").style.display = "inline-block";
					document.getElementById("file-selection-upload-matrix").style.display = "inline-block";
				}
			}
		}
	</script>
	<script>
		var previewElementMatrix = document.getElementById("graphion-matrix-dropzone-template");
		var previewTemplateMatrix = previewElementMatrix.parentNode.innerHTML;
		previewElementMatrix.parentNode.parentNode.style.display = "none";
		previewElementMatrix.parentNode.removeChild(previewElementMatrix);

		Dropzone.options.graphionMatrixDropzone = {
			acceptedFiles: "text/csv,.csv",
			createImageThumbnails: true,
			dictDefaultMessage: "Drop files here or click to upload",
			maxFiles: 1,
			maxFilesize: 1000,
			paramName: "file",
			previewsContainer: "#previews-matrix",
			previewTemplate: previewTemplateMatrix,
			timeout: 300000,
			init: function() {
				this.on("addedfile", function(file) {
					document.querySelector(".preview-matrix-container").style.display = "inline-block";
					document.querySelector(".dz-default.dz-message").style.display = "none";
					file.previewElement.classList.add("type-" + file.name.split('.').pop());
					document.getElementById("file-selection-back").disabled = true;
				});
		        this.on("success", function(file) {
		            window.location = "/filter/" + file.xhr.response;
		        });
				this.on("uploadprogress", function(file, progress, bytesSent) {
					console.log("Uploading " + file.name + ". Already sent " + bytesSent + " bytes.");
					document.querySelector("[data-dz-uploadprogress-matrix]").style.width = progress + "%";

					if (progress == 100) {
						document.querySelector(".dz-progress.matrix").style.display = "none";
						document.querySelector(".loader.bar").style.display = "block";

						document.querySelector(".card-title").textContent = "Processing file...";
						document.querySelector(".card-subtitle.text-center").textContent = "Your file has been uploaded and we are currently processing it. You will be redirected after processing has completed.";
					}
				});
		    }
		};
	</script>
	<script>
		var previewElementEdgelist = document.getElementById("graphion-edgelist-dropzone-template");
		var previewTemplateEdgelist = previewElementEdgelist.parentNode.innerHTML;
		previewElementEdgelist.parentNode.parentNode.style.display = "none";
		previewElementEdgelist.parentNode.removeChild(previewElementEdgelist);

		Dropzone.options.graphionEdgelistDropzone = {
			acceptedFiles: ".txt,.edges,.edgelist",
			createImageThumbnails: true,
			dictDefaultMessage: "Drop files here or click to upload",
			maxFiles: 1,
			maxFilesize: 1,
			paramName: "file",
			previewsContainer: "#previews-edgelist",
			previewTemplate: previewTemplateEdgelist,
			timeout: 300000,
			init: function() {
				this.on("addedfile", function(file) {
					document.querySelector(".preview-edgelist-container").style.display = "inline-block";
					document.querySelectorAll(".dz-default.dz-message")[1].style.display = "none";
					file.previewElement.classList.add("type-edges"); // force type since file.type is empty
					document.getElementById("file-selection-back").disabled = true;
				});
		        this.on("success", function(file) {
		            window.location = "/filter/" + file.xhr.response;
		        });
				this.on("uploadprogress", function(file, progress, bytesSent) {
					console.log("Uploading " + file.name + ". Already sent " + bytesSent + " bytes.");
					document.querySelector("[data-dz-uploadprogress-edgelist]").style.width = progress + "%";

					if (progress == 100) {
						document.querySelector(".dz-progress.edgelist").style.display = "none";
						document.querySelector(".loader.bar").style.display = "block";

						document.querySelector(".card-title").textContent = "Processing file...";
						document.querySelector(".card-subtitle.text-center").textContent = "Your file has been uploaded and we are currently processing it. You will be redirected after processing has completed.";
					}
				});
		    }
		};
	</script>
</html>